<head>
  <link rel="stylesheet" href="styles.css" />

  <link rel="preconnect" href="https://rsms.me/" />
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body>
  <main class="avatar-picker-container">
    <div class="stage-container">
      <div class="stage dropzone" id="stage">
        <img src="/assets/stage-c.png" width="100%" />
      </div>
      <button id="stage-button">Confirm your outfit</button>
      <p class="prompt">Create your avatar</p>
    </div>

    <img src="/assets/tops/compressed_images/1.png" width="180" class="draggable outfit-item" />
    <img src="/assets/tops/compressed_images/2.png" width="180" class="draggable outfit-item" />
    <img src="/assets/tops/compressed_images/3.png" width="180" class="draggable outfit-item" />
    <img src="/assets/tops/compressed_images/4.png" width="180" class="draggable outfit-item" />
    <img src="/assets/tops/compressed_images/5.png" width="180" class="draggable outfit-item" />
    <img src="/assets/tops/compressed_images/6.png" width="180" class="draggable outfit-item" />
    <img src="/assets/tops/compressed_images/7.png" width="180" class="draggable outfit-item" />
    <img src="/assets/tops/compressed_images/8.png" width="180" class="draggable outfit-item" />

    <img src="/assets/bottoms/compressed_images/1.png" width="140" class="draggable outfit-item" />
    <img src="/assets/bottoms/compressed_images/2.png" width="140" class="draggable outfit-item" />
    <img src="/assets/bottoms/compressed_images/3.png" width="140" class="draggable outfit-item" />
    <img src="/assets/bottoms/compressed_images/4.png" width="140" class="draggable outfit-item" />
    <img src="/assets/bottoms/compressed_images/5.png" width="140" class="draggable outfit-item" />

    <img src="/assets/shoes/compressed_images/ballet.png" width="120" class="draggable outfit-item" />
    <img src="/assets/shoes/compressed_images/boots.png" width="120" class="draggable outfit-item" />
    <img src="/assets/shoes/compressed_images/camper.png" width="120" class="draggable outfit-item" />
    <img src="/assets/shoes/compressed_images/kittens.png" width="120" class="draggable outfit-item" />
    <img src="/assets/shoes/compressed_images/metalic.png" width="120" class="draggable outfit-item" />

    <img src="/assets/accessories/compressed_images/bag.png" width="120" class="draggable outfit-item" />
    <img src="/assets/accessories/compressed_images/hat.png" width="120" class="draggable outfit-item" />
    <img src="/assets/accessories/compressed_images/hellokittybag.png" width="120" class="draggable outfit-item" />
    <img src="/assets/accessories/compressed_images/topblue.png" width="120" class="draggable outfit-item" />
  </main>

  <script src="/scripts/vendor/interact.min.js"></script>
  <script src="/scripts/dragging.js"></script>
</body>






<script>
  const stageEl = document.getElementById('stage')
  const stageButtonEl = document.getElementById('stage-button')

  // const stageTopGap = stageEl.clientTop;
  // const stageLeftGap = stageEl.clientLeft;

  stageButtonEl.addEventListener('click', async event => {
    console.log('aadding to canvas and screenshotting', window.inDropzone);

    const imgs = Object.values(window.inDropzone);

    const offscreen = new OffscreenCanvas(300, 600);

    drawImagesToCanvas(offscreen, imgs)

    // step 2: get the data URL of the Canvas and save it to localStorage and print it out
    offscreen.convertToBlob().then(blob => {
      console.log('blob', blob)
  
      var image = new Image();
      image.src = URL.createObjectURL(blob);
      document.body.appendChild(image);

      blobToDataUrl(blob, (dataUrl) => {
        localStorage.setItem('avatar', JSON.stringify({
          imageUrl: dataUrl,
          label: "avatar",
          datetime: Date.now()
        }))


        // Now finally navigate to the next page
        window.location = 'feeling.html'
      })
    })
})

function drawImagesToCanvas(canvas, images) {
  const ctx = canvas.getContext('2d');

  const stageEl = document.getElementById('stage')

  const stageTopGap = window.pageYOffset + stageEl.getBoundingClientRect().top
  const stageLeftGap = window.pageXOffset + stageEl.getBoundingClientRect().left

  // TODO: Fix sort
  const sortedImages = images.sort((a, b) => {
    const aZ = a.style.zIndex || 0;
    const bZ = b.style.zIndex || 0;

    return aZ - bZ;
  })

  images.forEach(image => {
    // step 1: layout the images on canvas  
    const imgTopGap = window.pageYOffset + image.getBoundingClientRect().top;
    const imgLeftGap = window.pageXOffset + image.getBoundingClientRect().left;
    
    const canvasTop = imgTopGap - stageTopGap;
    const canvasLeft = imgLeftGap - stageLeftGap;
  
    console.log('top, left, width, height')
    console.log(canvasTop, canvasLeft, image.clientWidth, image.clientHeight)
  
    ctx.drawImage(image, canvasLeft, canvasTop, image.clientWidth, image.clientHeight);
  })
}



function blobToDataUrl(blob, callback) {
  var a = new FileReader();
  a.onload = function(e) {
    callback(e.target.result);
  }
  a.readAsDataURL(blob);
}
</script>

















<!-- <script>
// CANVAS STUFF!!!!!!!!!
// =====================
const canvas = document.querySelector('canvas');
const ctx = canvas.getContext('2d');

// Get the list of images from document.images
const imageList = Array.from(document.images);

// Set the canvas dimensions based on the number of images
// canvas.width = 400; // Adjust width as needed
// canvas.height = imageList.length * 50; // Adjust height as needed

const topsImages = [
  '/assets/tops/compressed_images/1.png',
  '/assets/tops/compressed_images/2.png',
  '/assets/tops/compressed_images/3.png',
  '/assets/tops/compressed_images/4.png',
  '/assets/tops/compressed_images/5.png',
  '/assets/tops/compressed_images/6.png',
  '/assets/tops/compressed_images/7.png',
  '/assets/tops/compressed_images/8.png',
]

const bottomsImages = [
  '/assets/bottoms/compressed_images/1.png',
  '/assets/bottoms/compressed_images/2.png',
  '/assets/bottoms/compressed_images/3.png',
  '/assets/bottoms/compressed_images/4.png',
  '/assets/bottoms/compressed_images/5.png',
]

const shoesImages = [
  '/assets/shoes/compressed_images/ballet.png',
  '/assets/shoes/compressed_images/boots.png',
  '/assets/shoes/compressed_images/camper.png',
  '/assets/shoes/compressed_images/kittens.png',
  '/assets/shoes/compressed_images/metalic.png',
]

// Loop through the images and render them in a list format
topsImages.forEach((imageSrc, index) => {
  const width = 150;
  const padding = 15;
  const height = 150;

  const yPos = 0;
  const xPos = (width + padding) * index;

  // Load the actual image into the rectangle
  const img = new Image();
  img.onload = () => {
    ctx.drawImage(img, xPos, yPos, width, height);
  };
  img.src = imageSrc;
});

bottomsImages.forEach((imageSrc, index) => {
  const width = 150;
  const padding = 15;
  const height = 150;

  const yPos = 200;
  const xPos = (width + padding) * index;

  // Load the actual image into the rectangle
  const img = new Image();
  img.onload = () => {
    ctx.drawImage(img, xPos, yPos, width, height);
  };
  img.src = imageSrc;
});

</script> -->
